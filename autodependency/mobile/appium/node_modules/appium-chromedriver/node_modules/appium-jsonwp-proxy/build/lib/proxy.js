'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireWildcard = require('babel-runtime/helpers/interop-require-wildcard')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _import = require('lodash');

var _import2 = _interopRequireWildcard(_import);

var _mockRequest = require('../test/mock-request');

var _log = require('appium-logger');

var _log2 = _interopRequireWildcard(_log);

var _realRequest = require('request');

var _realRequest2 = _interopRequireWildcard(_realRequest);

var _jwpStatus = require('jsonwp-status');

var _jwpStatus2 = _interopRequireWildcard(_jwpStatus);

var _Q = require('q');

var _Q2 = _interopRequireWildcard(_Q);

function truncate(json) {
  var chars = arguments[1] === undefined ? 200 : arguments[1];

  json = json || '';
  if (typeof json !== 'string') {
    json = JSON.stringify(json);
  }
  var ext = json.length > chars ? '...' : '';
  return json.slice(0, chars) + ext;
}

function safeJson(body) {
  try {
    body = JSON.parse(body);
  } catch (e) {}
  return body;
}

var JWProxy = (function () {
  function JWProxy() {
    var opts = arguments[0] === undefined ? {} : arguments[0];

    _classCallCheck(this, JWProxy);

    _Object$assign(this, {
      scheme: 'http',
      server: 'localhost',
      port: 4444,
      base: '/wd/hub',
      sessionId: null,
      mockRequest: false
    }, opts);
    this.scheme = this.scheme.toLowerCase();
  }

  _createClass(JWProxy, [{
    key: 'request',
    value: function request() {
      for (var _len = arguments.length, args = Array(_len), _key = 0; _key < _len; _key++) {
        args[_key] = arguments[_key];
      }

      if (this.mockRequest) {
        return _mockRequest.request.apply(undefined, args);
      } else {
        return _realRequest2['default'].apply(undefined, args);
      }
    }
  }, {
    key: 'endpointRequiresSessionId',
    value: function endpointRequiresSessionId(endpoint) {
      return !_import2['default'].contains(['/session', '/sessions', '/status'], endpoint);
    }
  }, {
    key: 'getUrlForProxy',
    value: function getUrlForProxy(url) {
      if (url === '') url = '/';
      var proxyBase = '' + this.scheme + '://' + this.server + ':' + this.port + '' + this.base;
      var endpointRe = '(/(session|status))';
      var rest = '';
      if (/^http/.test(url)) {
        var first = new RegExp('(https?://.+)' + endpointRe).exec(url);
        if (!first) {
          throw new Error('Got a complete url but could not extract JWP endpoint');
        }
        rest = url.replace(first[1], '');
      } else if (new RegExp('^/').test(url)) {
        rest = url;
      } else {
        throw new Error('Didn\'t know what to do with url \'' + url + '\'');
      }
      var requiresSessionId = this.endpointRequiresSessionId(rest);

      if (requiresSessionId && this.sessionId === null) {
        throw new Error('Trying to proxy a session command without session id');
      }

      var stripPrefixRe = new RegExp('^.+(/(session|status).*)$');
      if (stripPrefixRe.test(rest)) {
        rest = stripPrefixRe.exec(rest)[1];
      }

      if (!new RegExp(endpointRe).test(rest)) {
        rest = '/session/' + this.sessionId + '' + rest;
      }

      var sessionBaseRe = new RegExp('^/session/([^/]+)');
      if (sessionBaseRe.test(rest)) {
        // we have something like /session/:id/foobar, so we need to replace
        // the session id
        var match = sessionBaseRe.exec(rest);
        rest = rest.replace(match[1], this.sessionId);
      } else if (requiresSessionId) {
        throw new Error('Got bad session base with rest of url: ' + rest);
      }
      rest = rest.replace(/\/$/, ''); // can't have trailing slashes
      return proxyBase + rest;
    }
  }, {
    key: 'proxy',
    value: function proxy(url, method) {
      var body = arguments[2] === undefined ? null : arguments[2];

      var newUrl, reqOpts, res, resBody, _ref, _ref2;

      return _regeneratorRuntime.async(function proxy$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            method = method.toUpperCase();
            newUrl = this.getUrlForProxy(url);
            reqOpts = {
              url: this.getUrlForProxy(url),
              method: method,
              headers: { 'Content-type': 'application/json;charset=UTF=8' }
            };

            if (body !== null) {
              if (typeof body !== 'object') {
                body = JSON.parse(body);
              }
              reqOpts.json = body;
            }
            _log2['default'].info('Proxying [' + method + ' ' + (url || '/') + '] to [' + method + ' ' + newUrl + ']' + (body ? ' with body: ' + truncate(body) : ' with no body'));
            res = undefined, resBody = undefined;
            context$2$0.prev = 6;
            context$2$0.next = 9;
            return _Q2['default'].ninvoke(this, 'request', reqOpts);

          case 9:
            _ref = context$2$0.sent;
            _ref2 = _slicedToArray(_ref, 2);
            res = _ref2[0];
            resBody = _ref2[1];

            _log2['default'].info('Got response with status ' + res.statusCode + ': ' + truncate(resBody));
            if (/\/session$/.test(url) && method === 'POST') {
              if (res.statusCode === 200) {
                this.sessionId = resBody.sessionId;
              } else if (res.statusCode === 303) {
                this.sessionId = /\/session\/([^\/]+)/.exec(resBody)[1];
              }
            }
            context$2$0.next = 20;
            break;

          case 17:
            context$2$0.prev = 17;
            context$2$0.t0 = context$2$0['catch'](6);
            throw new Error('Could not proxy command to remote server. ' + ('Original error: ' + context$2$0.t0.message));

          case 20:
            return context$2$0.abrupt('return', [res, resBody]);

          case 21:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[6, 17]]);
    }
  }, {
    key: 'command',
    value: function command(url, method) {
      var body = arguments[2] === undefined ? null : arguments[2];

      var _ref3, _ref32, response, resBody, statusCodesWithRes, message, e;

      return _regeneratorRuntime.async(function command$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return this.proxy(url, method, body);

          case 2:
            _ref3 = context$2$0.sent;
            _ref32 = _slicedToArray(_ref3, 2);
            response = _ref32[0];
            resBody = _ref32[1];
            statusCodesWithRes = [100, 200, 500];

            resBody = safeJson(resBody);

            if (!(_import2['default'].contains(statusCodesWithRes, response.statusCode) && (_import2['default'].isUndefined(resBody.status) || _import2['default'].isUndefined(resBody.value)))) {
              context$2$0.next = 10;
              break;
            }

            throw new Error('Did not get a valid response object. Object was: ' + JSON.stringify(resBody));

          case 10:
            if (!_import2['default'].contains(statusCodesWithRes, response.statusCode)) {
              context$2$0.next = 24;
              break;
            }

            if (!(response.statusCode === 200 && resBody.status === 0)) {
              context$2$0.next = 15;
              break;
            }

            return context$2$0.abrupt('return', resBody.value);

          case 15:
            if (!(response.statusCode === 200 && _import2['default'].isUndefined(resBody.status))) {
              context$2$0.next = 17;
              break;
            }

            return context$2$0.abrupt('return', resBody);

          case 17:
            message = _jwpStatus2['default'].getSummaryByCode(resBody.status);

            if (resBody.value.message) {
              message += ' (Original error: ' + resBody.value.message + ')';
            }
            e = new Error(message);

            e.status = resBody.status;
            e.value = resBody.value;
            e.httpCode = response.statusCode;
            throw e;

          case 24:
            throw new Error('Didn\'t know what to do with response code ' + response.statusCode);

          case 25:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'proxyReqRes',
    value: function proxyReqRes(req, res) {
      var _ref4, _ref42, response, body;

      return _regeneratorRuntime.async(function proxyReqRes$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return this.proxy(req.originalUrl, req.method, req.body);

          case 2:
            _ref4 = context$2$0.sent;
            _ref42 = _slicedToArray(_ref4, 2);
            response = _ref42[0];
            body = _ref42[1];

            res.headers = response.headers;
            res.set('Content-type', response.headers['content-type']);
            // if the proxied response contains a sessionId that the downstream
            // driver has generated, we don't want to return that to the client.
            // Instead, return the id for the current session
            body = safeJson(body);
            if (body && body.sessionId && this.sessionId) {
              body.sessionId = this.sessionId;
            }
            res.status(response.statusCode).send(JSON.stringify(body));

          case 11:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }]);

  return JWProxy;
})();

exports['default'] = JWProxy;
module.exports = exports['default'];
//# sourceMappingURL=data:application/json;base64,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TyxHQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUM7QUFDL0IsZUFBRyxDQUFDLEdBQUcsQ0FBQyxjQUFjLEVBQUUsUUFBUSxDQUFDLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDOzs7O0FBSTFELGdCQUFJLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ3RCLGdCQUFJLElBQUksSUFBSSxJQUFJLENBQUMsU0FBUyxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7QUFDNUMsa0JBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQzthQUNqQztBQUNELGVBQUcsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7Ozs7Ozs7S0FDNUQ7OztTQS9JRyxPQUFPOzs7cUJBa0pFLE9BQU8iLCJmaWxlIjoibGliL3Byb3h5LmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IHJlcXVlc3QgYXMgbW9ja1JlcXVlc3QgfSBmcm9tICcuLi90ZXN0L21vY2stcmVxdWVzdCc7XG5pbXBvcnQgeyBkZWZhdWx0IGFzIGxvZyB9IGZyb20gJ2FwcGl1bS1sb2dnZXInO1xuaW1wb3J0IHJlYWxSZXF1ZXN0IGZyb20gJ3JlcXVlc3QnO1xuaW1wb3J0IGp3cFN0YXR1cyBmcm9tICdqc29ud3Atc3RhdHVzJztcbmltcG9ydCBRIGZyb20gJ3EnO1xuXG5mdW5jdGlvbiB0cnVuY2F0ZSAoanNvbiwgY2hhcnMgPSAyMDApIHtcbiAganNvbiA9IGpzb24gfHwgXCJcIjtcbiAgaWYgKHR5cGVvZiBqc29uICE9PSBcInN0cmluZ1wiKSB7XG4gICAganNvbiA9IEpTT04uc3RyaW5naWZ5KGpzb24pO1xuICB9XG4gIGNvbnN0IGV4dCA9IGpzb24ubGVuZ3RoID4gY2hhcnMgPyAnLi4uJyA6ICcnO1xuICByZXR1cm4ganNvbi5zbGljZSgwLCBjaGFycykgKyBleHQ7XG59XG5cbmZ1bmN0aW9uIHNhZmVKc29uIChib2R5KSB7XG4gIHRyeSB7XG4gICAgYm9keSA9IEpTT04ucGFyc2UoYm9keSk7XG4gIH0gY2F0Y2ggKGUpIHt9XG4gIHJldHVybiBib2R5O1xufVxuXG5jbGFzcyBKV1Byb3h5IHtcbiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSkge1xuICAgIE9iamVjdC5hc3NpZ24odGhpcywge1xuICAgICAgc2NoZW1lOiAnaHR0cCcsXG4gICAgICBzZXJ2ZXI6ICdsb2NhbGhvc3QnLFxuICAgICAgcG9ydDogNDQ0NCxcbiAgICAgIGJhc2U6ICcvd2QvaHViJyxcbiAgICAgIHNlc3Npb25JZDogbnVsbCxcbiAgICAgIG1vY2tSZXF1ZXN0OiBmYWxzZVxuICAgIH0sIG9wdHMpO1xuICAgIHRoaXMuc2NoZW1lID0gdGhpcy5zY2hlbWUudG9Mb3dlckNhc2UoKTtcbiAgfVxuXG4gIHJlcXVlc3QgKC4uLmFyZ3MpIHtcbiAgICBpZiAodGhpcy5tb2NrUmVxdWVzdCkge1xuICAgICAgcmV0dXJuIG1vY2tSZXF1ZXN0KC4uLmFyZ3MpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gcmVhbFJlcXVlc3QoLi4uYXJncyk7XG4gICAgfVxuICB9XG5cbiAgZW5kcG9pbnRSZXF1aXJlc1Nlc3Npb25JZCAoZW5kcG9pbnQpIHtcbiAgICByZXR1cm4gIV8uY29udGFpbnMoW1wiL3Nlc3Npb25cIiwgXCIvc2Vzc2lvbnNcIiwgXCIvc3RhdHVzXCJdLCBlbmRwb2ludCk7XG4gIH1cblxuICBnZXRVcmxGb3JQcm94eSAodXJsKSB7XG4gICAgaWYgKHVybCA9PT0gXCJcIikgdXJsID0gXCIvXCI7XG4gICAgY29uc3QgcHJveHlCYXNlID0gYCR7dGhpcy5zY2hlbWV9Oi8vJHt0aGlzLnNlcnZlcn06JHt0aGlzLnBvcnR9JHt0aGlzLmJhc2V9YDtcbiAgICBjb25zdCBlbmRwb2ludFJlID0gJygvKHNlc3Npb258c3RhdHVzKSknO1xuICAgIGxldCByZXN0ID0gXCJcIjtcbiAgICBpZiAoL15odHRwLy50ZXN0KHVybCkpIHtcbiAgICAgIGNvbnN0IGZpcnN0ID0gKG5ldyBSZWdFeHAoJyhodHRwcz86Ly8uKyknICsgZW5kcG9pbnRSZSkpLmV4ZWModXJsKTtcbiAgICAgIGlmICghZmlyc3QpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiR290IGEgY29tcGxldGUgdXJsIGJ1dCBjb3VsZCBub3QgZXh0cmFjdCBKV1AgZW5kcG9pbnRcIik7XG4gICAgICB9XG4gICAgICByZXN0ID0gdXJsLnJlcGxhY2UoZmlyc3RbMV0sICcnKTtcbiAgICB9IGVsc2UgaWYgKChuZXcgUmVnRXhwKCdeLycpKS50ZXN0KHVybCkpIHtcbiAgICAgIHJlc3QgPSB1cmw7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkRpZG4ndCBrbm93IHdoYXQgdG8gZG8gd2l0aCB1cmwgJ1wiICsgdXJsICsgXCInXCIpO1xuICAgIH1cbiAgICBjb25zdCByZXF1aXJlc1Nlc3Npb25JZCA9IHRoaXMuZW5kcG9pbnRSZXF1aXJlc1Nlc3Npb25JZChyZXN0KTtcblxuICAgIGlmIChyZXF1aXJlc1Nlc3Npb25JZCAmJiB0aGlzLnNlc3Npb25JZCA9PT0gbnVsbCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiVHJ5aW5nIHRvIHByb3h5IGEgc2Vzc2lvbiBjb21tYW5kIHdpdGhvdXQgc2Vzc2lvbiBpZFwiKTtcbiAgICB9XG5cbiAgICBjb25zdCBzdHJpcFByZWZpeFJlID0gbmV3IFJlZ0V4cCgnXi4rKC8oc2Vzc2lvbnxzdGF0dXMpLiopJCcpO1xuICAgIGlmIChzdHJpcFByZWZpeFJlLnRlc3QocmVzdCkpIHtcbiAgICAgIHJlc3QgPSBzdHJpcFByZWZpeFJlLmV4ZWMocmVzdClbMV07XG4gICAgfVxuXG4gICAgaWYgKCEobmV3IFJlZ0V4cChlbmRwb2ludFJlKSkudGVzdChyZXN0KSkge1xuICAgICAgcmVzdCA9IGAvc2Vzc2lvbi8ke3RoaXMuc2Vzc2lvbklkfSR7cmVzdH1gO1xuICAgIH1cblxuICAgIGNvbnN0IHNlc3Npb25CYXNlUmUgPSBuZXcgUmVnRXhwKCdeL3Nlc3Npb24vKFteL10rKScpO1xuICAgIGlmIChzZXNzaW9uQmFzZVJlLnRlc3QocmVzdCkpIHtcbiAgICAgIC8vIHdlIGhhdmUgc29tZXRoaW5nIGxpa2UgL3Nlc3Npb24vOmlkL2Zvb2Jhciwgc28gd2UgbmVlZCB0byByZXBsYWNlXG4gICAgICAvLyB0aGUgc2Vzc2lvbiBpZFxuICAgICAgY29uc3QgbWF0Y2ggPSBzZXNzaW9uQmFzZVJlLmV4ZWMocmVzdCk7XG4gICAgICByZXN0ID0gcmVzdC5yZXBsYWNlKG1hdGNoWzFdLCB0aGlzLnNlc3Npb25JZCk7XG4gICAgfSBlbHNlIGlmIChyZXF1aXJlc1Nlc3Npb25JZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiR290IGJhZCBzZXNzaW9uIGJhc2Ugd2l0aCByZXN0IG9mIHVybDogXCIgKyByZXN0KTtcbiAgICB9XG4gICAgcmVzdCA9IHJlc3QucmVwbGFjZSgvXFwvJC8sICcnKTsgLy8gY2FuJ3QgaGF2ZSB0cmFpbGluZyBzbGFzaGVzXG4gICAgcmV0dXJuIHByb3h5QmFzZSArIHJlc3Q7XG4gIH1cblxuICBhc3luYyBwcm94eSAodXJsLCBtZXRob2QsIGJvZHkgPSBudWxsKSB7XG4gICAgbWV0aG9kID0gbWV0aG9kLnRvVXBwZXJDYXNlKCk7XG4gICAgY29uc3QgbmV3VXJsID0gdGhpcy5nZXRVcmxGb3JQcm94eSh1cmwpO1xuICAgIGNvbnN0IHJlcU9wdHMgPSB7XG4gICAgICB1cmw6IHRoaXMuZ2V0VXJsRm9yUHJveHkodXJsKSxcbiAgICAgIG1ldGhvZCxcbiAgICAgIGhlYWRlcnM6IHsnQ29udGVudC10eXBlJzogJ2FwcGxpY2F0aW9uL2pzb247Y2hhcnNldD1VVEY9OCd9XG4gICAgfTtcbiAgICBpZiAoYm9keSAhPT0gbnVsbCkge1xuICAgICAgaWYgKHR5cGVvZiBib2R5ICE9PSAnb2JqZWN0Jykge1xuICAgICAgICBib2R5ID0gSlNPTi5wYXJzZShib2R5KTtcbiAgICAgIH1cbiAgICAgIHJlcU9wdHMuanNvbiA9IGJvZHk7XG4gICAgfVxuICAgIGxvZy5pbmZvKGBQcm94eWluZyBbJHttZXRob2R9ICR7dXJsIHx8IFwiL1wifV0gdG8gWyR7bWV0aG9kfSAke25ld1VybH1dYCArXG4gICAgICAgICAgICAgKGJvZHkgPyBgIHdpdGggYm9keTogJHt0cnVuY2F0ZShib2R5KX1gIDogJyB3aXRoIG5vIGJvZHknKSk7XG4gICAgbGV0IHJlcywgcmVzQm9keTtcbiAgICB0cnkge1xuICAgICAgW3JlcywgcmVzQm9keV0gPSBhd2FpdCBRLm5pbnZva2UodGhpcywgJ3JlcXVlc3QnLCByZXFPcHRzKTtcbiAgICAgIGxvZy5pbmZvKGBHb3QgcmVzcG9uc2Ugd2l0aCBzdGF0dXMgJHtyZXMuc3RhdHVzQ29kZX06ICR7dHJ1bmNhdGUocmVzQm9keSl9YCk7XG4gICAgICBpZiAoL1xcL3Nlc3Npb24kLy50ZXN0KHVybCkgJiYgbWV0aG9kID09PSBcIlBPU1RcIikge1xuICAgICAgICBpZiAocmVzLnN0YXR1c0NvZGUgPT09IDIwMCkge1xuICAgICAgICAgIHRoaXMuc2Vzc2lvbklkID0gcmVzQm9keS5zZXNzaW9uSWQ7XG4gICAgICAgIH0gZWxzZSBpZiAocmVzLnN0YXR1c0NvZGUgPT09IDMwMykge1xuICAgICAgICAgIHRoaXMuc2Vzc2lvbklkID0gL1xcL3Nlc3Npb25cXC8oW15cXC9dKykvLmV4ZWMocmVzQm9keSlbMV07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDb3VsZCBub3QgcHJveHkgY29tbWFuZCB0byByZW1vdGUgc2VydmVyLiBcIiArXG4gICAgICAgICAgICAgICAgICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgICB9XG4gICAgcmV0dXJuIFtyZXMsIHJlc0JvZHldO1xuICB9XG5cbiAgYXN5bmMgY29tbWFuZCAodXJsLCBtZXRob2QsIGJvZHkgPSBudWxsKSB7XG4gICAgbGV0IFtyZXNwb25zZSwgcmVzQm9keV0gPSBhd2FpdCB0aGlzLnByb3h5KHVybCwgbWV0aG9kLCBib2R5KTtcbiAgICBsZXQgc3RhdHVzQ29kZXNXaXRoUmVzID0gWzEwMCwgMjAwLCA1MDBdO1xuICAgIHJlc0JvZHkgPSBzYWZlSnNvbihyZXNCb2R5KTtcbiAgICBpZiAoXy5jb250YWlucyhzdGF0dXNDb2Rlc1dpdGhSZXMsIHJlc3BvbnNlLnN0YXR1c0NvZGUpICYmXG4gICAgICAgIChfLmlzVW5kZWZpbmVkKHJlc0JvZHkuc3RhdHVzKSB8fCBfLmlzVW5kZWZpbmVkKHJlc0JvZHkudmFsdWUpKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRGlkIG5vdCBnZXQgYSB2YWxpZCByZXNwb25zZSBvYmplY3QuIE9iamVjdCB3YXM6IFwiICtcbiAgICAgICAgICAgICAgICAgICAgICBKU09OLnN0cmluZ2lmeShyZXNCb2R5KSk7XG4gICAgfVxuICAgIGlmIChfLmNvbnRhaW5zKHN0YXR1c0NvZGVzV2l0aFJlcywgcmVzcG9uc2Uuc3RhdHVzQ29kZSkpIHtcbiAgICAgIGlmIChyZXNwb25zZS5zdGF0dXNDb2RlID09PSAyMDAgJiYgcmVzQm9keS5zdGF0dXMgPT09IDApIHtcbiAgICAgICAgcmV0dXJuIHJlc0JvZHkudmFsdWU7XG4gICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLnN0YXR1c0NvZGUgPT09IDIwMCAmJiBfLmlzVW5kZWZpbmVkKHJlc0JvZHkuc3RhdHVzKSkge1xuICAgICAgICByZXR1cm4gcmVzQm9keTtcbiAgICAgIH1cbiAgICAgIGxldCBtZXNzYWdlID0gandwU3RhdHVzLmdldFN1bW1hcnlCeUNvZGUocmVzQm9keS5zdGF0dXMpO1xuICAgICAgaWYgKHJlc0JvZHkudmFsdWUubWVzc2FnZSkge1xuICAgICAgICBtZXNzYWdlICs9IGAgKE9yaWdpbmFsIGVycm9yOiAke3Jlc0JvZHkudmFsdWUubWVzc2FnZX0pYDtcbiAgICAgIH1cbiAgICAgIGxldCBlID0gbmV3IEVycm9yKG1lc3NhZ2UpO1xuICAgICAgZS5zdGF0dXMgPSByZXNCb2R5LnN0YXR1cztcbiAgICAgIGUudmFsdWUgPSByZXNCb2R5LnZhbHVlO1xuICAgICAgZS5odHRwQ29kZSA9IHJlc3BvbnNlLnN0YXR1c0NvZGU7XG4gICAgICB0aHJvdyBlO1xuICAgIH1cbiAgICB0aHJvdyBuZXcgRXJyb3IoYERpZG4ndCBrbm93IHdoYXQgdG8gZG8gd2l0aCByZXNwb25zZSBjb2RlICR7cmVzcG9uc2Uuc3RhdHVzQ29kZX1gKTtcbiAgfVxuXG4gIGFzeW5jIHByb3h5UmVxUmVzIChyZXEsIHJlcykge1xuICAgIGxldCBbcmVzcG9uc2UsIGJvZHldID0gYXdhaXQgdGhpcy5wcm94eShyZXEub3JpZ2luYWxVcmwsIHJlcS5tZXRob2QsIHJlcS5ib2R5KTtcbiAgICByZXMuaGVhZGVycyA9IHJlc3BvbnNlLmhlYWRlcnM7XG4gICAgcmVzLnNldCgnQ29udGVudC10eXBlJywgcmVzcG9uc2UuaGVhZGVyc1snY29udGVudC10eXBlJ10pO1xuICAgIC8vIGlmIHRoZSBwcm94aWVkIHJlc3BvbnNlIGNvbnRhaW5zIGEgc2Vzc2lvbklkIHRoYXQgdGhlIGRvd25zdHJlYW1cbiAgICAvLyBkcml2ZXIgaGFzIGdlbmVyYXRlZCwgd2UgZG9uJ3Qgd2FudCB0byByZXR1cm4gdGhhdCB0byB0aGUgY2xpZW50LlxuICAgIC8vIEluc3RlYWQsIHJldHVybiB0aGUgaWQgZm9yIHRoZSBjdXJyZW50IHNlc3Npb25cbiAgICBib2R5ID0gc2FmZUpzb24oYm9keSk7XG4gICAgaWYgKGJvZHkgJiYgYm9keS5zZXNzaW9uSWQgJiYgdGhpcy5zZXNzaW9uSWQpIHtcbiAgICAgIGJvZHkuc2Vzc2lvbklkID0gdGhpcy5zZXNzaW9uSWQ7XG4gICAgfVxuICAgIHJlcy5zdGF0dXMocmVzcG9uc2Uuc3RhdHVzQ29kZSkuc2VuZChKU09OLnN0cmluZ2lmeShib2R5KSk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgSldQcm94eTtcbiJdfQ==