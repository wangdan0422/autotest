'use strict';

var _inherits = require('babel-runtime/helpers/inherits')['default'];

var _get = require('babel-runtime/helpers/get')['default'];

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireWildcard = require('babel-runtime/helpers/interop-require-wildcard')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _events = require('events');

var _events2 = _interopRequireWildcard(_events);

var _JWProxy = require('appium-jsonwp-proxy');

var _log = require('appium-logger');

var _log2 = _interopRequireWildcard(_log);

var _npmChromedriver = require('chromedriver');

var _npmChromedriver2 = _interopRequireWildcard(_npmChromedriver);

var _cp = require('child_process');

var _cp2 = _interopRequireWildcard(_cp);

var _through = require('through');

var _through2 = _interopRequireWildcard(_through);

var _support = require('appium-support');

var _support2 = _interopRequireWildcard(_support);

var _retryInterval = require('asyncbox');

var _Q = require('q');

var _Q2 = _interopRequireWildcard(_Q);

require('source-map-support').install();

var spawn = _cp2['default'].spawn;

var DEFAULT_HOST = '127.0.0.1';
var DEFAULT_PORT = 9515;

var Chromedriver = (function (_events$EventEmitter) {
  function Chromedriver() {
    var args = arguments[0] === undefined ? {} : arguments[0];

    _classCallCheck(this, Chromedriver);

    var host = args.host;
    var port = args.port;
    var executable = args.executable;
    var cmdArgs = args.cmdArgs;

    _get(Object.getPrototypeOf(Chromedriver.prototype), 'constructor', this).call(this);
    this.proxyHost = host || DEFAULT_HOST;
    this.proxyPort = port || DEFAULT_PORT;
    this.cmdArgs = cmdArgs;
    this.proc = null;
    this.chromedriver = executable || Chromedriver.getPath();
    this.state = Chromedriver.STATE_STOPPED;
    this.jwproxy = new _JWProxy.JWProxy({ server: this.proxyHost, port: this.proxyPort });
    _log2['default'].info('Set chromedriver binary as: ' + this.chromedriver);
  }

  _inherits(Chromedriver, _events$EventEmitter);

  _createClass(Chromedriver, [{
    key: 'start',
    value: function start(caps) {
      var d, args, handleStartErr;
      return _regeneratorRuntime.async(function start$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            d = _Q2['default'].defer();

            this.capabilities = caps;
            this.changeState(Chromedriver.STATE_STARTING);
            context$2$0.next = 5;
            return this.killAll();

          case 5:
            args = ['--url-base=wd/hub', '--port=' + this.proxyPort];

            _log2['default'].info('Spawning chromedriver with: ' + this.chromedriver + ' ' + args.join(' '));
            this.proc = spawn(this.chromedriver, args);
            this.proc.stdout.setEncoding('utf8');
            this.proc.stderr.setEncoding('utf8');

            handleStartErr = function handleStartErr(err) {
              _this.proc.removeAllListeners('exit');
              _this.proc.kill('SIGINT');
              d.reject(err);
            };

            this.proc.on('error', function (err) {
              var newErr = new Error('Chromedriver process failed with error: ' + err.message);
              _log2['default'].error(newErr.message);
              _this.emit(Chromedriver.EVENT_ERROR, newErr);
              handleStartErr(err);
            });

            this.proc.stdout.pipe(_through2['default'](function (data) {
              _log2['default'].info('[CHROMEDRIVER STDOUT] ' + data.trim());
              if (data.indexOf('Starting ') === 0) {
                (function callee$3$0() {
                  return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
                    while (1) switch (context$4$0.prev = context$4$0.next) {
                      case 0:
                        context$4$0.prev = 0;
                        context$4$0.next = 3;
                        return this.waitForOnline();

                      case 3:
                        context$4$0.next = 5;
                        return this.startSession();

                      case 5:
                        d.resolve();
                        context$4$0.next = 12;
                        break;

                      case 8:
                        context$4$0.prev = 8;
                        context$4$0.t0 = context$4$0['catch'](0);

                        handleStartErr(context$4$0.t0);
                        this.emit(Chromedriver.EVENT_ERROR, context$4$0.t0);

                      case 12:
                      case 'end':
                        return context$4$0.stop();
                    }
                  }, null, _this, [[0, 8]]);
                })();
              }
            }));

            this.proc.stderr.pipe(_through2['default'](function (data) {
              _log2['default'].info('[CHROMEDRIVER STDERR] ' + data.trim());
            }));

            this.proc.on('exit', function (code, signal) {
              if (_this.state !== Chromedriver.STATE_STOPPED && _this.state !== Chromedriver.STATE_STOPPING) {
                var msg = 'Chromedriver exited unexpectedly with code ' + code + ', ' + ('signal ' + signal);
                _log2['default'].error(msg);
                _this.changeState(Chromedriver.STATE_STOPPED);
              }
            });
            return context$2$0.abrupt('return', d.promise);

          case 16:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'sessionId',
    value: function sessionId() {
      if (this.state !== Chromedriver.STATE_ONLINE) {
        return null;
      }

      return this.jwproxy.sessionId;
    }
  }, {
    key: 'restart',
    value: function restart() {
      var p;
      return _regeneratorRuntime.async(function restart$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _log2['default'].info('Restarting chromedriver');
            if (this.state !== Chromedriver.STATE_ONLINE) {
              this.emit(Chromedriver.EVENT_ERROR, new Error('Can\'t restart when we\'re not online'));
            }
            p = this._statePromise(Chromedriver.STATE_STOPPED);

            this.stop();
            _log2['default'].info('Waiting for chromedriver to completely stop');
            context$2$0.next = 7;
            return p;

          case 7:
            context$2$0.next = 9;
            return this.start(this.capabilities);

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: '_statePromise',
    value: function _statePromise() {
      var state = arguments[0] === undefined ? null : arguments[0];

      var d = _Q2['default'].defer();
      var listener = (function (msg) {
        if (state === null || msg.state === state) {
          d.resolve(msg.state);
          this.removeListener(Chromedriver.EVENT_CHANGED, listener);
        }
      }).bind(this);
      this.on(Chromedriver.EVENT_CHANGED, listener);
      return d.promise;
    }
  }, {
    key: 'waitForOnline',
    value: function waitForOnline() {
      return _regeneratorRuntime.async(function waitForOnline$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _retryInterval.retryInterval(20, 200, this.getStatus.bind(this));

          case 2:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'getStatus',
    value: function getStatus() {
      return _regeneratorRuntime.async(function getStatus$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return this.jwproxy.command('/status', 'GET');

          case 2:
            return context$2$0.abrupt('return', context$2$0.sent);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startSession',
    value: function startSession() {
      return _regeneratorRuntime.async(function startSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _retryInterval.retryInterval(4, 200, this.jwproxy.command.bind(this.jwproxy), '/session', 'POST', { desiredCapabilities: this.capabilities });

          case 2:
            this.changeState(Chromedriver.STATE_ONLINE);

          case 3:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'stop',
    value: function stop() {
      var d;
      return _regeneratorRuntime.async(function stop$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            this.changeState(Chromedriver.STATE_STOPPING);
            d = _Q2['default'].defer();

            this.proc.on('close', d.resolve);
            context$2$0.prev = 3;
            context$2$0.next = 6;
            return this.jwproxy.command('', 'DELETE');

          case 6:
            this.proc.kill('SIGINT');
            context$2$0.next = 9;
            return d.promise;

          case 9:
            this.changeState(Chromedriver.STATE_STOPPED);
            context$2$0.next = 15;
            break;

          case 12:
            context$2$0.prev = 12;
            context$2$0.t1 = context$2$0['catch'](3);

            _log2['default'].error(context$2$0.t1);

          case 15:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[3, 12]]);
    }
  }, {
    key: 'changeState',
    value: function changeState(state) {
      this.state = state;
      this.emit(Chromedriver.EVENT_CHANGED, { state: state });
    }
  }, {
    key: 'sendCommand',
    value: function sendCommand(url, method, body) {
      return this.jwproxy.command(url, method, body);
    }
  }, {
    key: 'proxyReq',
    value: function proxyReq(req, res) {
      return this.jwproxy.proxyReqRes(req, res);
    }
  }, {
    key: 'killAll',
    value: function killAll() {
      var cmd;
      return _regeneratorRuntime.async(function killAll$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            cmd = undefined;

            if (_support2['default'].system.isWindows()) {
              cmd = 'FOR /F "usebackq tokens=5" %a in (`netstat -nao ^| ' + 'findstr /R /C:"' + this.proxyPort + ' "`) do (' + 'FOR /F "usebackq" %b in (`TASKLIST /FI "PID eq %a" ^| ' + 'findstr /I chromedriver.exe`) do (IF NOT %b=="" TASKKILL ' + '/F /PID %a))';
            } else {
              cmd = 'ps -ef | grep ' + this.chromedriver + ' | grep -v grep |' + 'grep -e \'--port=' + this.proxyPort + '\\(\\s.*\\)\\?$\' | awk ' + '\'{ print $2 }\' | xargs kill -15';
            }
            _log2['default'].info('Killing any old chromedrivers, running: ' + cmd);
            context$2$0.prev = 3;
            context$2$0.next = 6;
            return _Q2['default'].nfcall(_cp2['default'].exec, cmd);

          case 6:
            _log2['default'].info('Successfully cleaned up old chromedrivers');
            context$2$0.next = 12;
            break;

          case 9:
            context$2$0.prev = 9;
            context$2$0.t2 = context$2$0['catch'](3);

            _log2['default'].info('No old chromedrivers seemed to exist');

          case 12:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[3, 9]]);
    }
  }, {
    key: 'hasWorkingWebview',
    value: function hasWorkingWebview() {
      return _regeneratorRuntime.async(function hasWorkingWebview$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.prev = 0;
            context$2$0.next = 3;
            return this.jwproxy.command('/url', 'GET');

          case 3:
            return context$2$0.abrupt('return', true);

          case 6:
            context$2$0.prev = 6;
            context$2$0.t3 = context$2$0['catch'](0);
            return context$2$0.abrupt('return', false);

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[0, 6]]);
    }
  }], [{
    key: 'getPath',
    value: function getPath() {
      return _npmChromedriver2['default'].path;
    }
  }]);

  return Chromedriver;
})(_events2['default'].EventEmitter);

Chromedriver.EVENT_ERROR = 'chromedriver_error';
Chromedriver.EVENT_CHANGED = 'stateChanged';
Chromedriver.STATE_STOPPED = 'stopped';
Chromedriver.STATE_STARTING = 'starting';
Chromedriver.STATE_ONLINE = 'online';
Chromedriver.STATE_STOPPING = 'stopping';

exports['default'] = Chromedriver;
module.exports = exports['default'];

// retry session start 4 times, sometimes this fails due to adb

// sometimes chromedriver stops automating webviews. this method runs a
// simple command to determine our state, and responds accordingly
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jaHJvbWVkcml2ZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7O3NCQUVtQixRQUFROzs7O3VCQUNILHFCQUFxQjs7bUJBQ2QsZUFBZTs7OzsrQkFDbEIsY0FBYzs7OztrQkFDM0IsZUFBZTs7Ozt1QkFDVixTQUFTOzs7O3VCQUNULGdCQUFnQjs7Ozs2QkFDTixVQUFVOztpQkFDMUIsR0FBRzs7OztBQVZqQixPQUFPLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQzs7SUFXaEMsS0FBSyxtQkFBTCxLQUFLOztBQUViLElBQU0sWUFBWSxHQUFHLFdBQVcsQ0FBQztBQUNqQyxJQUFNLFlBQVksR0FBRyxJQUFJLENBQUM7O0lBRXBCLFlBQVk7QUFDSixXQURSLFlBQVksR0FDUTtRQUFYLElBQUksZ0NBQUcsRUFBRTs7MEJBRGxCLFlBQVk7O1FBRVAsSUFBSSxHQUErQixJQUFJLENBQXZDLElBQUk7UUFBRSxJQUFJLEdBQXlCLElBQUksQ0FBakMsSUFBSTtRQUFFLFVBQVUsR0FBYSxJQUFJLENBQTNCLFVBQVU7UUFBRSxPQUFPLEdBQUksSUFBSSxDQUFmLE9BQU87O0FBQ3RDLCtCQUhFLFlBQVksNkNBR047QUFDUixRQUFJLENBQUMsU0FBUyxHQUFHLElBQUksSUFBSSxZQUFZLENBQUM7QUFDdEMsUUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLElBQUksWUFBWSxDQUFDO0FBQ3RDLFFBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO0FBQ3ZCLFFBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO0FBQ2pCLFFBQUksQ0FBQyxZQUFZLEdBQUcsVUFBVSxJQUFJLFlBQVksQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUN6RCxRQUFJLENBQUMsS0FBSyxHQUFHLFlBQVksQ0FBQyxhQUFhLENBQUM7QUFDeEMsUUFBSSxDQUFDLE9BQU8sR0FBRyxhQXZCVixPQUFPLENBdUJlLEVBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxTQUFTLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxTQUFTLEVBQUMsQ0FBQyxDQUFDO0FBQzNFLHFCQUFJLElBQUksQ0FBQyw4QkFBOEIsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7R0FDOUQ7O1lBWkcsWUFBWTs7ZUFBWixZQUFZOztXQWNKLGVBQUMsSUFBSTtVQUNYLENBQUMsRUFJQyxJQUFJLEVBTUosY0FBYzs7Ozs7O0FBVmhCLGFBQUMsR0FBRyxlQUFFLEtBQUssRUFBRTs7QUFDakIsZ0JBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxDQUFDO0FBQ3pCLGdCQUFJLENBQUMsV0FBVyxDQUFDLFlBQVksQ0FBQyxjQUFjLENBQUMsQ0FBQzs7bUJBQ3hDLElBQUksQ0FBQyxPQUFPLEVBQUU7OztBQUNkLGdCQUFJLEdBQUcsQ0FBQyxtQkFBbUIsY0FBWSxJQUFJLENBQUMsU0FBUyxDQUFHOztBQUM5RCw2QkFBSSxJQUFJLGtDQUFnQyxJQUFJLENBQUMsWUFBWSxTQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUcsQ0FBQztBQUMvRSxnQkFBSSxDQUFDLElBQUksR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsQ0FBQztBQUMzQyxnQkFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQ3JDLGdCQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7O0FBRS9CLDBCQUFjLEdBQUcsd0JBQUMsR0FBRyxFQUFLO0FBQzlCLG9CQUFLLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUNyQyxvQkFBSyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ3pCLGVBQUMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7YUFDZjs7QUFFRCxnQkFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLFVBQUEsR0FBRyxFQUFJO0FBQzNCLGtCQUFNLE1BQU0sR0FBRyxJQUFJLEtBQUssQ0FBQywwQ0FBMEMsR0FDMUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQ3RDLCtCQUFJLEtBQUssQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7QUFDMUIsb0JBQUssSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFDNUMsNEJBQWMsQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUNyQixDQUFDLENBQUM7O0FBRUgsZ0JBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxxQkFBUSxVQUFBLElBQUksRUFBSTtBQUNwQywrQkFBSSxJQUFJLENBQUMsd0JBQXdCLEdBQUcsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7QUFDakQsa0JBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLEVBQUU7QUFDbkMsaUJBQUM7Ozs7OzsrQkFFUyxJQUFJLENBQUMsYUFBYSxFQUFFOzs7OytCQUNwQixJQUFJLENBQUMsWUFBWSxFQUFFOzs7QUFDekIseUJBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQzs7Ozs7Ozs7QUFFWixzQ0FBYyxnQkFBRyxDQUFDO0FBQ2xCLDRCQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLGlCQUFJLENBQUM7Ozs7Ozs7a0JBRTFDLEVBQUcsQ0FBQztlQUNOO2FBQ0YsQ0FBQyxDQUFDLENBQUM7O0FBRUosZ0JBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxxQkFBUSxVQUFBLElBQUksRUFBSTtBQUNwQywrQkFBSSxJQUFJLENBQUMsd0JBQXdCLEdBQUcsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7YUFDbEQsQ0FBQyxDQUFDLENBQUM7O0FBRUosZ0JBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRSxVQUFDLElBQUksRUFBRSxNQUFNLEVBQUs7QUFDckMsa0JBQUksTUFBSyxLQUFLLEtBQUssWUFBWSxDQUFDLGFBQWEsSUFDekMsTUFBSyxLQUFLLEtBQUssWUFBWSxDQUFDLGNBQWMsRUFBRTtBQUM5QyxvQkFBSSxHQUFHLEdBQUcsZ0RBQThDLElBQUksdUJBQ3hDLE1BQU0sQ0FBRSxDQUFDO0FBQzdCLGlDQUFJLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUNmLHNCQUFLLFdBQVcsQ0FBQyxZQUFZLENBQUMsYUFBYSxDQUFDLENBQUM7ZUFDOUM7YUFDRixDQUFDLENBQUM7Z0RBQ0ksQ0FBQyxDQUFDLE9BQU87Ozs7Ozs7S0FDakI7OztXQUVTLHFCQUFHO0FBQ1gsVUFBSSxJQUFJLENBQUMsS0FBSyxLQUFLLFlBQVksQ0FBQyxZQUFZLEVBQUU7QUFDNUMsZUFBTyxJQUFJLENBQUM7T0FDYjs7QUFFRCxhQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDO0tBQy9COzs7V0FFYTtVQU1SLENBQUM7Ozs7QUFMTCw2QkFBSSxJQUFJLENBQUMseUJBQXlCLENBQUMsQ0FBQztBQUNwQyxnQkFBSSxJQUFJLENBQUMsS0FBSyxLQUFLLFlBQVksQ0FBQyxZQUFZLEVBQUU7QUFDNUMsa0JBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFDeEIsSUFBSSxLQUFLLENBQUMsdUNBQXFDLENBQUMsQ0FBQyxDQUFDO2FBQzdEO0FBQ0csYUFBQyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsWUFBWSxDQUFDLGFBQWEsQ0FBQzs7QUFDdEQsZ0JBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztBQUNaLDZCQUFJLElBQUksQ0FBQyw2Q0FBNkMsQ0FBQyxDQUFDOzttQkFDbEQsQ0FBQzs7OzttQkFDRCxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUM7Ozs7Ozs7S0FDcEM7OztXQUVhLHlCQUFlO1VBQWQsS0FBSyxnQ0FBRyxJQUFJOztBQUN6QixVQUFJLENBQUMsR0FBRyxlQUFFLEtBQUssRUFBRSxDQUFDO0FBQ2xCLFVBQU0sUUFBUSxHQUFHLENBQUEsVUFBVSxHQUFHLEVBQUU7QUFDOUIsWUFBSSxLQUFLLEtBQUssSUFBSSxJQUFJLEdBQUcsQ0FBQyxLQUFLLEtBQUssS0FBSyxFQUFFO0FBQ3pDLFdBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQ3JCLGNBQUksQ0FBQyxjQUFjLENBQUMsWUFBWSxDQUFDLGFBQWEsRUFBRSxRQUFRLENBQUMsQ0FBQztTQUMzRDtPQUNGLENBQUEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDYixVQUFJLENBQUMsRUFBRSxDQUFDLFlBQVksQ0FBQyxhQUFhLEVBQUUsUUFBUSxDQUFDLENBQUM7QUFDOUMsYUFBTyxDQUFDLENBQUMsT0FBTyxDQUFDO0tBQ2xCOzs7V0FFbUI7Ozs7O21CQUNaLGVBaEhELGFBQWEsQ0FnSEUsRUFBRSxFQUFFLEdBQUcsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQzs7Ozs7OztLQUN4RDs7O1dBRWU7Ozs7O21CQUNELElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxLQUFLLENBQUM7Ozs7Ozs7Ozs7S0FDcEQ7OztXQUVrQjs7Ozs7bUJBRVgsZUF6SEQsYUFBYSxDQXlIRSxDQUFDLEVBQUUsR0FBRyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQy9ELFVBQVUsRUFBRSxNQUFNLEVBQUUsRUFBQyxtQkFBbUIsRUFBRSxJQUFJLENBQUMsWUFBWSxFQUFDLENBQUM7OztBQUNqRSxnQkFBSSxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLENBQUM7Ozs7Ozs7S0FDN0M7OztXQUVVO1VBRUwsQ0FBQzs7OztBQURMLGdCQUFJLENBQUMsV0FBVyxDQUFDLFlBQVksQ0FBQyxjQUFjLENBQUMsQ0FBQztBQUMxQyxhQUFDLEdBQUcsZUFBRSxLQUFLLEVBQUU7O0FBQ2pCLGdCQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDOzs7bUJBRXpCLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEVBQUUsRUFBRSxRQUFRLENBQUM7OztBQUN4QyxnQkFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7O21CQUNuQixDQUFDLENBQUMsT0FBTzs7O0FBQ2YsZ0JBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLGFBQWEsQ0FBQyxDQUFDOzs7Ozs7OztBQUU3Qyw2QkFBSSxLQUFLLGdCQUFHLENBQUM7Ozs7Ozs7S0FFaEI7OztXQUVXLHFCQUFDLEtBQUssRUFBRTtBQUNsQixVQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztBQUNuQixVQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxhQUFhLEVBQUUsRUFBQyxLQUFLLEVBQUUsS0FBSyxFQUFDLENBQUMsQ0FBQztLQUN2RDs7O1dBRVcscUJBQUMsR0FBRyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUU7QUFDOUIsYUFBTyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO0tBQ2hEOzs7V0FFUSxrQkFBQyxHQUFHLEVBQUUsR0FBRyxFQUFFO0FBQ2xCLGFBQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0tBQzNDOzs7V0FFYTtVQUNSLEdBQUc7Ozs7QUFBSCxlQUFHOztBQUNQLGdCQUFJLHFCQUFRLE1BQU0sQ0FBQyxTQUFTLEVBQUUsRUFBRTtBQUM5QixpQkFBRyxHQUFHLHFEQUF1RCxHQUN2RCxpQkFBa0IsR0FBRyxJQUFJLENBQUMsU0FBUyxHQUFHLFdBQVksR0FDbEQsd0RBQTRELEdBQzVELDJEQUE2RCxHQUM3RCxjQUFjLENBQUM7YUFDdEIsTUFBTTtBQUNMLGlCQUFHLEdBQUcsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLFlBQVksR0FBRyxtQkFBbUIsR0FDMUQsbUJBQWtCLEdBQUcsSUFBSSxDQUFDLFNBQVMsR0FBRywwQkFBeUIsR0FDL0QsbUNBQWlDLENBQUM7YUFDekM7QUFDRCw2QkFBSSxJQUFJLENBQUMsMENBQTBDLEdBQUcsR0FBRyxDQUFDLENBQUM7OzttQkFFbkQsZUFBRSxNQUFNLENBQUMsZ0JBQUcsSUFBSSxFQUFFLEdBQUcsQ0FBQzs7O0FBQzVCLDZCQUFJLElBQUksQ0FBQywyQ0FBMkMsQ0FBQyxDQUFDOzs7Ozs7OztBQUV0RCw2QkFBSSxJQUFJLENBQUMsc0NBQXNDLENBQUMsQ0FBQzs7Ozs7OztLQUVwRDs7O1dBRXVCOzs7Ozs7bUJBSWQsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLEtBQUssQ0FBQzs7O2dEQUNsQyxJQUFJOzs7OztnREFFSixLQUFLOzs7Ozs7O0tBRWY7OztXQUVjLG1CQUFHO0FBQ2hCLGFBQU8sNkJBQWdCLElBQUksQ0FBQztLQUM3Qjs7O1NBckxHLFlBQVk7R0FBUyxvQkFBTyxZQUFZOztBQXdMOUMsWUFBWSxDQUFDLFdBQVcsR0FBRyxvQkFBb0IsQ0FBQztBQUNoRCxZQUFZLENBQUMsYUFBYSxHQUFHLGNBQWMsQ0FBQztBQUM1QyxZQUFZLENBQUMsYUFBYSxHQUFHLFNBQVMsQ0FBQztBQUN2QyxZQUFZLENBQUMsY0FBYyxHQUFHLFVBQVUsQ0FBQztBQUN6QyxZQUFZLENBQUMsWUFBWSxHQUFHLFFBQVEsQ0FBQztBQUNyQyxZQUFZLENBQUMsY0FBYyxHQUFHLFVBQVUsQ0FBQzs7cUJBRTFCLFlBQVkiLCJmaWxlIjoibGliL2Nocm9tZWRyaXZlci5qcyIsInNvdXJjZXNDb250ZW50IjpbInJlcXVpcmUoJ3NvdXJjZS1tYXAtc3VwcG9ydCcpLmluc3RhbGwoKTtcblxuaW1wb3J0IGV2ZW50cyBmcm9tICdldmVudHMnO1xuaW1wb3J0IHsgSldQcm94eSB9IGZyb20gJ2FwcGl1bS1qc29ud3AtcHJveHknO1xuaW1wb3J0IHsgZGVmYXVsdCBhcyBsb2cgfSBmcm9tICdhcHBpdW0tbG9nZ2VyJztcbmltcG9ydCBucG1DaHJvbWVkcml2ZXIgZnJvbSAnY2hyb21lZHJpdmVyJztcbmltcG9ydCBjcCBmcm9tICdjaGlsZF9wcm9jZXNzJztcbmltcG9ydCB0aHJvdWdoIGZyb20gJ3Rocm91Z2gnO1xuaW1wb3J0IHN1cHBvcnQgZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgcmV0cnlJbnRlcnZhbCB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCBRIGZyb20gJ3EnO1xuY29uc3QgeyBzcGF3biB9ID0gY3A7XG5cbmNvbnN0IERFRkFVTFRfSE9TVCA9ICcxMjcuMC4wLjEnO1xuY29uc3QgREVGQVVMVF9QT1JUID0gOTUxNTtcblxuY2xhc3MgQ2hyb21lZHJpdmVyIGV4dGVuZHMgZXZlbnRzLkV2ZW50RW1pdHRlciB7XG4gIGNvbnN0cnVjdG9yIChhcmdzID0ge30pIHtcbiAgICBjb25zdCB7aG9zdCwgcG9ydCwgZXhlY3V0YWJsZSwgY21kQXJnc30gPSBhcmdzO1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5wcm94eUhvc3QgPSBob3N0IHx8IERFRkFVTFRfSE9TVDtcbiAgICB0aGlzLnByb3h5UG9ydCA9IHBvcnQgfHwgREVGQVVMVF9QT1JUO1xuICAgIHRoaXMuY21kQXJncyA9IGNtZEFyZ3M7XG4gICAgdGhpcy5wcm9jID0gbnVsbDtcbiAgICB0aGlzLmNocm9tZWRyaXZlciA9IGV4ZWN1dGFibGUgfHwgQ2hyb21lZHJpdmVyLmdldFBhdGgoKTtcbiAgICB0aGlzLnN0YXRlID0gQ2hyb21lZHJpdmVyLlNUQVRFX1NUT1BQRUQ7XG4gICAgdGhpcy5qd3Byb3h5ID0gbmV3IEpXUHJveHkoe3NlcnZlcjogdGhpcy5wcm94eUhvc3QsIHBvcnQ6IHRoaXMucHJveHlQb3J0fSk7XG4gICAgbG9nLmluZm8oXCJTZXQgY2hyb21lZHJpdmVyIGJpbmFyeSBhczogXCIgKyB0aGlzLmNocm9tZWRyaXZlcik7XG4gIH1cblxuICBhc3luYyBzdGFydCAoY2Fwcykge1xuICAgIGxldCBkID0gUS5kZWZlcigpO1xuICAgIHRoaXMuY2FwYWJpbGl0aWVzID0gY2FwcztcbiAgICB0aGlzLmNoYW5nZVN0YXRlKENocm9tZWRyaXZlci5TVEFURV9TVEFSVElORyk7XG4gICAgYXdhaXQgdGhpcy5raWxsQWxsKCk7XG4gICAgY29uc3QgYXJncyA9IFtcIi0tdXJsLWJhc2U9d2QvaHViXCIsIGAtLXBvcnQ9JHt0aGlzLnByb3h5UG9ydH1gXTtcbiAgICBsb2cuaW5mbyhgU3Bhd25pbmcgY2hyb21lZHJpdmVyIHdpdGg6ICR7dGhpcy5jaHJvbWVkcml2ZXJ9ICR7YXJncy5qb2luKCcgJyl9YCk7XG4gICAgdGhpcy5wcm9jID0gc3Bhd24odGhpcy5jaHJvbWVkcml2ZXIsIGFyZ3MpO1xuICAgIHRoaXMucHJvYy5zdGRvdXQuc2V0RW5jb2RpbmcoJ3V0ZjgnKTtcbiAgICB0aGlzLnByb2Muc3RkZXJyLnNldEVuY29kaW5nKCd1dGY4Jyk7XG5cbiAgICBjb25zdCBoYW5kbGVTdGFydEVyciA9IChlcnIpID0+IHtcbiAgICAgIHRoaXMucHJvYy5yZW1vdmVBbGxMaXN0ZW5lcnMoJ2V4aXQnKTtcbiAgICAgIHRoaXMucHJvYy5raWxsKCdTSUdJTlQnKTtcbiAgICAgIGQucmVqZWN0KGVycik7XG4gICAgfTtcblxuICAgIHRoaXMucHJvYy5vbignZXJyb3InLCBlcnIgPT4ge1xuICAgICAgY29uc3QgbmV3RXJyID0gbmV3IEVycm9yKCdDaHJvbWVkcml2ZXIgcHJvY2VzcyBmYWlsZWQgd2l0aCBlcnJvcjogJyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyLm1lc3NhZ2UpO1xuICAgICAgbG9nLmVycm9yKG5ld0Vyci5tZXNzYWdlKTtcbiAgICAgIHRoaXMuZW1pdChDaHJvbWVkcml2ZXIuRVZFTlRfRVJST1IsIG5ld0Vycik7XG4gICAgICBoYW5kbGVTdGFydEVycihlcnIpO1xuICAgIH0pO1xuXG4gICAgdGhpcy5wcm9jLnN0ZG91dC5waXBlKHRocm91Z2goZGF0YSA9PiB7XG4gICAgICBsb2cuaW5mbygnW0NIUk9NRURSSVZFUiBTVERPVVRdICcgKyBkYXRhLnRyaW0oKSk7XG4gICAgICBpZiAoZGF0YS5pbmRleE9mKCdTdGFydGluZyAnKSA9PT0gMCkge1xuICAgICAgICAoYXN5bmMgKCkgPT4ge1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLndhaXRGb3JPbmxpbmUoKTtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuc3RhcnRTZXNzaW9uKCk7XG4gICAgICAgICAgICBkLnJlc29sdmUoKTtcbiAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICBoYW5kbGVTdGFydEVycihlKTtcbiAgICAgICAgICAgIHRoaXMuZW1pdChDaHJvbWVkcml2ZXIuRVZFTlRfRVJST1IsIGUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSkoKTtcbiAgICAgIH1cbiAgICB9KSk7XG5cbiAgICB0aGlzLnByb2Muc3RkZXJyLnBpcGUodGhyb3VnaChkYXRhID0+IHtcbiAgICAgIGxvZy5pbmZvKCdbQ0hST01FRFJJVkVSIFNUREVSUl0gJyArIGRhdGEudHJpbSgpKTtcbiAgICB9KSk7XG5cbiAgICB0aGlzLnByb2Mub24oJ2V4aXQnLCAoY29kZSwgc2lnbmFsKSA9PiB7XG4gICAgICBpZiAodGhpcy5zdGF0ZSAhPT0gQ2hyb21lZHJpdmVyLlNUQVRFX1NUT1BQRUQgJiZcbiAgICAgICAgICB0aGlzLnN0YXRlICE9PSBDaHJvbWVkcml2ZXIuU1RBVEVfU1RPUFBJTkcpIHtcbiAgICAgICAgbGV0IG1zZyA9IGBDaHJvbWVkcml2ZXIgZXhpdGVkIHVuZXhwZWN0ZWRseSB3aXRoIGNvZGUgJHtjb2RlfSwgYCArXG4gICAgICAgICAgICAgICAgICBgc2lnbmFsICR7c2lnbmFsfWA7XG4gICAgICAgIGxvZy5lcnJvcihtc2cpO1xuICAgICAgICB0aGlzLmNoYW5nZVN0YXRlKENocm9tZWRyaXZlci5TVEFURV9TVE9QUEVEKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gZC5wcm9taXNlO1xuICB9XG5cbiAgc2Vzc2lvbklkICgpIHtcbiAgICBpZiAodGhpcy5zdGF0ZSAhPT0gQ2hyb21lZHJpdmVyLlNUQVRFX09OTElORSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuandwcm94eS5zZXNzaW9uSWQ7XG4gIH1cblxuICBhc3luYyByZXN0YXJ0ICgpIHtcbiAgICBsb2cuaW5mbyhcIlJlc3RhcnRpbmcgY2hyb21lZHJpdmVyXCIpO1xuICAgIGlmICh0aGlzLnN0YXRlICE9PSBDaHJvbWVkcml2ZXIuU1RBVEVfT05MSU5FKSB7XG4gICAgICB0aGlzLmVtaXQoQ2hyb21lZHJpdmVyLkVWRU5UX0VSUk9SLFxuICAgICAgICAgICAgICAgIG5ldyBFcnJvcihcIkNhbid0IHJlc3RhcnQgd2hlbiB3ZSdyZSBub3Qgb25saW5lXCIpKTtcbiAgICB9XG4gICAgbGV0IHAgPSB0aGlzLl9zdGF0ZVByb21pc2UoQ2hyb21lZHJpdmVyLlNUQVRFX1NUT1BQRUQpO1xuICAgIHRoaXMuc3RvcCgpO1xuICAgIGxvZy5pbmZvKFwiV2FpdGluZyBmb3IgY2hyb21lZHJpdmVyIHRvIGNvbXBsZXRlbHkgc3RvcFwiKTtcbiAgICBhd2FpdCBwO1xuICAgIGF3YWl0IHRoaXMuc3RhcnQodGhpcy5jYXBhYmlsaXRpZXMpO1xuICB9XG5cbiAgX3N0YXRlUHJvbWlzZSAoc3RhdGUgPSBudWxsKSB7XG4gICAgbGV0IGQgPSBRLmRlZmVyKCk7XG4gICAgY29uc3QgbGlzdGVuZXIgPSBmdW5jdGlvbiAobXNnKSB7XG4gICAgICBpZiAoc3RhdGUgPT09IG51bGwgfHwgbXNnLnN0YXRlID09PSBzdGF0ZSkge1xuICAgICAgICBkLnJlc29sdmUobXNnLnN0YXRlKTtcbiAgICAgICAgdGhpcy5yZW1vdmVMaXN0ZW5lcihDaHJvbWVkcml2ZXIuRVZFTlRfQ0hBTkdFRCwgbGlzdGVuZXIpO1xuICAgICAgfVxuICAgIH0uYmluZCh0aGlzKTtcbiAgICB0aGlzLm9uKENocm9tZWRyaXZlci5FVkVOVF9DSEFOR0VELCBsaXN0ZW5lcik7XG4gICAgcmV0dXJuIGQucHJvbWlzZTtcbiAgfVxuXG4gIGFzeW5jIHdhaXRGb3JPbmxpbmUgKCkge1xuICAgIGF3YWl0IHJldHJ5SW50ZXJ2YWwoMjAsIDIwMCwgdGhpcy5nZXRTdGF0dXMuYmluZCh0aGlzKSk7XG4gIH1cblxuICBhc3luYyBnZXRTdGF0dXMgKCkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmp3cHJveHkuY29tbWFuZCgnL3N0YXR1cycsICdHRVQnKTtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0U2Vzc2lvbiAoKSB7XG4gICAgLy8gcmV0cnkgc2Vzc2lvbiBzdGFydCA0IHRpbWVzLCBzb21ldGltZXMgdGhpcyBmYWlscyBkdWUgdG8gYWRiXG4gICAgYXdhaXQgcmV0cnlJbnRlcnZhbCg0LCAyMDAsIHRoaXMuandwcm94eS5jb21tYW5kLmJpbmQodGhpcy5qd3Byb3h5KSxcbiAgICAgICAgJy9zZXNzaW9uJywgJ1BPU1QnLCB7ZGVzaXJlZENhcGFiaWxpdGllczogdGhpcy5jYXBhYmlsaXRpZXN9KTtcbiAgICB0aGlzLmNoYW5nZVN0YXRlKENocm9tZWRyaXZlci5TVEFURV9PTkxJTkUpO1xuICB9XG5cbiAgYXN5bmMgc3RvcCAoKSB7XG4gICAgdGhpcy5jaGFuZ2VTdGF0ZShDaHJvbWVkcml2ZXIuU1RBVEVfU1RPUFBJTkcpO1xuICAgIGxldCBkID0gUS5kZWZlcigpO1xuICAgIHRoaXMucHJvYy5vbignY2xvc2UnLCBkLnJlc29sdmUpO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLmp3cHJveHkuY29tbWFuZCgnJywgJ0RFTEVURScpO1xuICAgICAgdGhpcy5wcm9jLmtpbGwoJ1NJR0lOVCcpO1xuICAgICAgYXdhaXQgZC5wcm9taXNlO1xuICAgICAgdGhpcy5jaGFuZ2VTdGF0ZShDaHJvbWVkcml2ZXIuU1RBVEVfU1RPUFBFRCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgbG9nLmVycm9yKGUpO1xuICAgIH1cbiAgfVxuXG4gIGNoYW5nZVN0YXRlIChzdGF0ZSkge1xuICAgIHRoaXMuc3RhdGUgPSBzdGF0ZTtcbiAgICB0aGlzLmVtaXQoQ2hyb21lZHJpdmVyLkVWRU5UX0NIQU5HRUQsIHtzdGF0ZTogc3RhdGV9KTtcbiAgfVxuXG4gIHNlbmRDb21tYW5kICh1cmwsIG1ldGhvZCwgYm9keSkge1xuICAgIHJldHVybiB0aGlzLmp3cHJveHkuY29tbWFuZCh1cmwsIG1ldGhvZCwgYm9keSk7XG4gIH1cblxuICBwcm94eVJlcSAocmVxLCByZXMpIHtcbiAgICByZXR1cm4gdGhpcy5qd3Byb3h5LnByb3h5UmVxUmVzKHJlcSwgcmVzKTtcbiAgfVxuXG4gIGFzeW5jIGtpbGxBbGwgKCkge1xuICAgIGxldCBjbWQ7XG4gICAgaWYgKHN1cHBvcnQuc3lzdGVtLmlzV2luZG93cygpKSB7XG4gICAgICBjbWQgPSBcIkZPUiAvRiBcXFwidXNlYmFja3EgdG9rZW5zPTVcXFwiICVhIGluIChgbmV0c3RhdCAtbmFvIF58IFwiICtcbiAgICAgICAgICAgIFwiZmluZHN0ciAvUiAvQzpcXFwiXCIgKyB0aGlzLnByb3h5UG9ydCArIFwiIFxcXCJgKSBkbyAoXCIgK1xuICAgICAgICAgICAgXCJGT1IgL0YgXFxcInVzZWJhY2txXFxcIiAlYiBpbiAoYFRBU0tMSVNUIC9GSSBcXFwiUElEIGVxICVhXFxcIiBefCBcIiArXG4gICAgICAgICAgICBcImZpbmRzdHIgL0kgY2hyb21lZHJpdmVyLmV4ZWApIGRvIChJRiBOT1QgJWI9PVxcXCJcXFwiIFRBU0tLSUxMIFwiICtcbiAgICAgICAgICAgIFwiL0YgL1BJRCAlYSkpXCI7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNtZCA9IFwicHMgLWVmIHwgZ3JlcCBcIiArIHRoaXMuY2hyb21lZHJpdmVyICsgXCIgfCBncmVwIC12IGdyZXAgfFwiICtcbiAgICAgICAgICAgIFwiZ3JlcCAtZSAnLS1wb3J0PVwiICsgdGhpcy5wcm94eVBvcnQgKyBcIlxcXFwoXFxcXHMuKlxcXFwpXFxcXD8kJyB8IGF3ayBcIiArXG4gICAgICAgICAgICBcIid7IHByaW50ICQyIH0nIHwgeGFyZ3Mga2lsbCAtMTVcIjtcbiAgICB9XG4gICAgbG9nLmluZm8oXCJLaWxsaW5nIGFueSBvbGQgY2hyb21lZHJpdmVycywgcnVubmluZzogXCIgKyBjbWQpO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBRLm5mY2FsbChjcC5leGVjLCBjbWQpO1xuICAgICAgbG9nLmluZm8oXCJTdWNjZXNzZnVsbHkgY2xlYW5lZCB1cCBvbGQgY2hyb21lZHJpdmVyc1wiKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy5pbmZvKFwiTm8gb2xkIGNocm9tZWRyaXZlcnMgc2VlbWVkIHRvIGV4aXN0XCIpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGhhc1dvcmtpbmdXZWJ2aWV3ICgpIHtcbiAgICAvLyBzb21ldGltZXMgY2hyb21lZHJpdmVyIHN0b3BzIGF1dG9tYXRpbmcgd2Vidmlld3MuIHRoaXMgbWV0aG9kIHJ1bnMgYVxuICAgIC8vIHNpbXBsZSBjb21tYW5kIHRvIGRldGVybWluZSBvdXIgc3RhdGUsIGFuZCByZXNwb25kcyBhY2NvcmRpbmdseVxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLmp3cHJveHkuY29tbWFuZCgnL3VybCcsICdHRVQnKTtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gIH1cblxuICBzdGF0aWMgZ2V0UGF0aCAoKSB7XG4gICAgcmV0dXJuIG5wbUNocm9tZWRyaXZlci5wYXRoO1xuICB9XG5cbn1cbkNocm9tZWRyaXZlci5FVkVOVF9FUlJPUiA9ICdjaHJvbWVkcml2ZXJfZXJyb3InO1xuQ2hyb21lZHJpdmVyLkVWRU5UX0NIQU5HRUQgPSAnc3RhdGVDaGFuZ2VkJztcbkNocm9tZWRyaXZlci5TVEFURV9TVE9QUEVEID0gJ3N0b3BwZWQnO1xuQ2hyb21lZHJpdmVyLlNUQVRFX1NUQVJUSU5HID0gJ3N0YXJ0aW5nJztcbkNocm9tZWRyaXZlci5TVEFURV9PTkxJTkUgPSAnb25saW5lJztcbkNocm9tZWRyaXZlci5TVEFURV9TVE9QUElORyA9ICdzdG9wcGluZyc7XG5cbmV4cG9ydCBkZWZhdWx0IENocm9tZWRyaXZlcjtcbiJdfQ==